<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<title>Bussipeatuste otsing</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<style>
body { background: linear-gradient(to right, #eef2f3, #8e9eab); font-family: 'Segoe UI', sans-serif; }
.container { max-width: 700px; background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); margin-top:50px; }
h1 { text-align:center; font-weight:600; color:#333; }
.ui-autocomplete { max-height:200px; overflow-y:auto; overflow-x:hidden; padding-right:20px; }
#busesList .bus-card { margin-bottom:15px; }
.bus-btn { display:flex; justify-content:space-between; width:100%; }
.bus-direction { font-size:0.85rem; color:#555; }
.arrival-card { padding:8px 12px; background:#f1f5f9; border-radius:8px; margin-top:5px; box-shadow:0 2px 5px rgba(0,0,0,0.1); font-size:0.9rem; }
#clearBtn, #loadBusesBtn { width:100%; margin-bottom:10px; }
</style>
</head>
<body>
<div class="container">
<h1>Bussipeatuste otsing</h1>

<div class="mb-3">
    <label for="stopInput" class="form-label">Otsi peatus</label>
    <input type="text" id="stopInput" class="form-control" placeholder="Alusta kirjutamist peatusenime...">
</div>

<button id="loadBusesBtn" class="btn btn-primary">Leia bussid</button>
<button id="clearBtn" class="btn btn-danger">Tühjenda</button>

<div id="busesList" class="mt-3"></div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script>
$(function(){
    let selectedStopId = null;
    let stopTripsMap = {};

    // Autocomplete for stops
    $("#stopInput").autocomplete({
        minLength: 2,
        source: function(req,res){
            $.get("/api/stops",{q:req.term}).done(res).fail(()=>res([]));
        },
        select: function(e,ui){
            $("#stopInput").val(ui.item.value);
            selectedStopId = ui.item.stop_id;
            stopTripsMap = {};
            return false;
        }
    }).autocomplete("instance")._renderItem=function(ul,item){
        return $("<li>").append(`<div>${item.label}</div>`).appendTo(ul);
    };

    // Load buses
    function loadBuses(){
        $("#busesList").empty();
        if(!selectedStopId){ return; }
        $.get("/api/buses",{stopId:selectedStopId}).done(buses=>{
            if(!buses.length){ $("#busesList").append("<div>Ühtegi bussi ei leitud</div>"); return; }
            buses.forEach(b=>{
                stopTripsMap[b.bus] = b.trip_id;
                const card = $(`
                    <div class="bus-card card p-2">
                        <button class="btn btn-outline-primary bus-btn">
                            <span>${b.bus}</span> <span class="bus-direction">${b.direction||''}</span>
                        </button>
                        <div class="arrival-list mt-1"></div>
                    </div>
                `);
                card.find("button").click(function(){
                    loadArrivals(b.bus, card.find(".arrival-list"));
                });
                $("#busesList").append(card);
            });
        });
    }

    $("#loadBusesBtn").click(loadBuses);

    $("#clearBtn").click(function(){
        $("#stopInput").val("");
        $("#busesList").empty();
        selectedStopId = null;
        stopTripsMap = {};
    });

    function loadArrivals(bus, container){
        container.empty();
        const tripId = stopTripsMap[bus];
        if(!tripId) return;
        $.get("/api/arrivals",{stopId:selectedStopId, tripIds: tripId}).done(times=>{
            if(!times.length){ container.append("<div class='arrival-card'>Ühtegi saabumist ei leitud</div>"); return; }
            times.forEach(t=>{
                container.append(`<div class='arrival-card'>${t.arrival_time} — ${t.trip_headsign}</div>`);
            });
        });
    }

    // ───────── Geolocation ─────────
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
            $.get("/api/nearest_stop",{lat: pos.coords.latitude, lon: pos.coords.longitude})
            .done(stop=>{
                if(stop){
                    selectedStopId = stop.stop_id;
                    $("#stopInput").val(stop.stop_name);
                    loadBuses(); // сразу загружаем автобусы для ближайшей остановки
                }
            });
        });
    }
});
</script>
</body>
</html>
